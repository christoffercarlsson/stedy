use crate::{
    sha1::Sha1,
    sha256::Sha256,
    sha512::Sha512,
    traits::{Digest, Hasher, KeyInit, Mac},
    verify::verify,
    xor::xor,
};

#[derive(Copy, Clone)]
pub struct Hmac<H, const BLOCK_SIZE: usize, const OUTPUT_SIZE: usize>
where
    H: Hasher<BLOCK_SIZE, OUTPUT_SIZE>,
{
    inner: H,
    outer: H,
}

impl<H, const BLOCK_SIZE: usize, const OUTPUT_SIZE: usize> Hmac<H, BLOCK_SIZE, OUTPUT_SIZE>
where
    H: Hasher<BLOCK_SIZE, OUTPUT_SIZE>,
{
    pub fn new(key: &[u8]) -> Self {
        let mut k = [0u8; BLOCK_SIZE];
        if key.len() > BLOCK_SIZE {
            let mut hasher = H::new();
            hasher.update(key);
            let key_digest = hasher.finalize();
            k[..OUTPUT_SIZE].copy_from_slice(&key_digest);
        } else {
            k[..key.len()].copy_from_slice(key);
        }
        let inner_pad = [54u8; BLOCK_SIZE];
        let outer_pad = [92u8; BLOCK_SIZE];
        let mut inner_key = [0u8; BLOCK_SIZE];
        let mut outer_key = [0u8; BLOCK_SIZE];
        xor(&k, &inner_pad, &mut inner_key);
        xor(&k, &outer_pad, &mut outer_key);
        let mut inner = H::new();
        let mut outer = H::new();
        inner.update(&inner_key);
        outer.update(&outer_key);
        Self { inner, outer }
    }

    pub fn update(&mut self, message: &[u8]) {
        self.inner.update(message);
    }

    pub fn finalize_into(mut self, code: &mut [u8; OUTPUT_SIZE]) {
        let digest = self.inner.finalize();
        self.outer.update(&digest);
        self.outer.finalize_into(code);
    }

    pub fn finalize(self) -> [u8; OUTPUT_SIZE] {
        let mut code = [0u8; OUTPUT_SIZE];
        self.finalize_into(&mut code);
        code
    }

    pub fn verify(self, code: &[u8; OUTPUT_SIZE]) -> bool {
        verify(code, &self.finalize())
    }
}

impl<H, const BLOCK_SIZE: usize, const OUTPUT_SIZE: usize> KeyInit
    for Hmac<H, BLOCK_SIZE, OUTPUT_SIZE>
where
    H: Hasher<BLOCK_SIZE, OUTPUT_SIZE>,
{
    fn new(key: &[u8]) -> Self {
        Self::new(key)
    }
}

impl<H, const BLOCK_SIZE: usize, const OUTPUT_SIZE: usize> Digest<OUTPUT_SIZE>
    for Hmac<H, BLOCK_SIZE, OUTPUT_SIZE>
where
    H: Hasher<BLOCK_SIZE, OUTPUT_SIZE>,
{
    fn update(&mut self, message: &[u8]) {
        self.update(message);
    }

    fn finalize(self) -> [u8; OUTPUT_SIZE] {
        self.finalize()
    }

    fn finalize_into(self, output: &mut [u8; OUTPUT_SIZE]) {
        self.finalize_into(output);
    }
}

impl<H, const BLOCK_SIZE: usize, const OUTPUT_SIZE: usize> Mac<OUTPUT_SIZE>
    for Hmac<H, BLOCK_SIZE, OUTPUT_SIZE>
where
    H: Hasher<BLOCK_SIZE, OUTPUT_SIZE>,
{
    fn verify(self, code: &[u8; OUTPUT_SIZE]) -> bool {
        self.verify(code)
    }
}

pub type HmacSha1 = Hmac<Sha1, 64, 20>;

pub fn hmac_sha1(key: &[u8], message: &[u8]) -> [u8; 20] {
    let mut hmac = HmacSha1::new(key);
    hmac.update(message);
    hmac.finalize()
}

pub fn hmac_sha1_verify(key: &[u8], message: &[u8], code: &[u8; 20]) -> bool {
    let mut hmac = HmacSha1::new(key);
    hmac.update(message);
    hmac.verify(code)
}

pub type HmacSha256 = Hmac<Sha256, 64, 32>;

pub fn hmac_sha256(key: &[u8], message: &[u8]) -> [u8; 32] {
    let mut hmac = HmacSha256::new(key);
    hmac.update(message);
    hmac.finalize()
}

pub fn hmac_sha256_verify(key: &[u8], message: &[u8], code: &[u8; 32]) -> bool {
    let mut hmac = HmacSha256::new(key);
    hmac.update(message);
    hmac.verify(code)
}

pub type HmacSha512 = Hmac<Sha512, 128, 64>;

pub fn hmac_sha512(key: &[u8], message: &[u8]) -> [u8; 64] {
    let mut hmac = HmacSha512::new(key);
    hmac.update(message);
    hmac.finalize()
}

pub fn hmac_sha512_verify(key: &[u8], message: &[u8], code: &[u8; 64]) -> bool {
    let mut hmac = HmacSha512::new(key);
    hmac.update(message);
    hmac.verify(code)
}

#[cfg(test)]
mod tests {
    use super::*;

    // https://datatracker.ietf.org/doc/html/rfc4231

    #[test]
    fn test_hmac_sha256_tc1() {
        let key = [
            11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11,
        ];
        let message = [72, 105, 32, 84, 104, 101, 114, 101];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                176, 52, 76, 97, 216, 219, 56, 83, 92, 168, 175, 206, 175, 11, 241, 43, 136, 29,
                194, 0, 201, 131, 61, 167, 38, 233, 55, 108, 46, 50, 207, 247,
            ]
        );
    }

    #[test]
    fn test_hmac_sha256_tc2() {
        let key = [74, 101, 102, 101];
        let message = [
            119, 104, 97, 116, 32, 100, 111, 32, 121, 97, 32, 119, 97, 110, 116, 32, 102, 111, 114,
            32, 110, 111, 116, 104, 105, 110, 103, 63,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                91, 220, 193, 70, 191, 96, 117, 78, 106, 4, 36, 38, 8, 149, 117, 199, 90, 0, 63, 8,
                157, 39, 57, 131, 157, 236, 88, 185, 100, 236, 56, 67,
            ]
        );
    }

    #[test]
    fn test_hmac_sha256_tc3() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170,
        ];
        let message = [
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                119, 62, 169, 30, 54, 128, 14, 70, 133, 77, 184, 235, 208, 145, 129, 167, 41, 89,
                9, 139, 62, 248, 193, 34, 217, 99, 85, 20, 206, 213, 101, 254,
            ]
        );
    }

    #[test]
    fn test_hmac_sha256_tc4() {
        let key = [
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24,
            25,
        ];
        let message = [
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                130, 85, 138, 56, 154, 68, 60, 14, 164, 204, 129, 152, 153, 242, 8, 58, 133, 240,
                250, 163, 229, 120, 248, 7, 122, 46, 63, 244, 103, 41, 102, 91,
            ]
        );
    }

    #[test]
    fn test_hmac_sha256_tc5() {
        let key = [
            12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12,
        ];
        let message = [
            84, 101, 115, 116, 32, 87, 105, 116, 104, 32, 84, 114, 117, 110, 99, 97, 116, 105, 111,
            110,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code[..16],
            [163, 182, 22, 116, 115, 16, 14, 224, 110, 12, 121, 108, 41, 85, 85, 43,]
        );
    }

    #[test]
    fn test_hmac_sha256_tc6() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
        ];
        let message = [
            84, 101, 115, 116, 32, 85, 115, 105, 110, 103, 32, 76, 97, 114, 103, 101, 114, 32, 84,
            104, 97, 110, 32, 66, 108, 111, 99, 107, 45, 83, 105, 122, 101, 32, 75, 101, 121, 32,
            45, 32, 72, 97, 115, 104, 32, 75, 101, 121, 32, 70, 105, 114, 115, 116,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                96, 228, 49, 89, 30, 224, 182, 127, 13, 138, 38, 170, 203, 245, 183, 127, 142, 11,
                198, 33, 55, 40, 197, 20, 5, 70, 4, 15, 14, 227, 127, 84,
            ]
        );
    }

    #[test]
    fn test_hmac_sha256_tc7() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
        ];
        let message = [
            84, 104, 105, 115, 32, 105, 115, 32, 97, 32, 116, 101, 115, 116, 32, 117, 115, 105,
            110, 103, 32, 97, 32, 108, 97, 114, 103, 101, 114, 32, 116, 104, 97, 110, 32, 98, 108,
            111, 99, 107, 45, 115, 105, 122, 101, 32, 107, 101, 121, 32, 97, 110, 100, 32, 97, 32,
            108, 97, 114, 103, 101, 114, 32, 116, 104, 97, 110, 32, 98, 108, 111, 99, 107, 45, 115,
            105, 122, 101, 32, 100, 97, 116, 97, 46, 32, 84, 104, 101, 32, 107, 101, 121, 32, 110,
            101, 101, 100, 115, 32, 116, 111, 32, 98, 101, 32, 104, 97, 115, 104, 101, 100, 32, 98,
            101, 102, 111, 114, 101, 32, 98, 101, 105, 110, 103, 32, 117, 115, 101, 100, 32, 98,
            121, 32, 116, 104, 101, 32, 72, 77, 65, 67, 32, 97, 108, 103, 111, 114, 105, 116, 104,
            109, 46,
        ];
        let code = hmac_sha256(&key, &message);
        let verified = hmac_sha256_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                155, 9, 255, 167, 27, 148, 47, 203, 39, 99, 95, 188, 213, 176, 233, 68, 191, 220,
                99, 100, 79, 7, 19, 147, 138, 127, 81, 83, 92, 58, 53, 226,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc1() {
        let key = [
            11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11,
        ];
        let message = [72, 105, 32, 84, 104, 101, 114, 101];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                135, 170, 124, 222, 165, 239, 97, 157, 79, 240, 180, 36, 26, 29, 108, 176, 35, 121,
                244, 226, 206, 78, 194, 120, 122, 208, 179, 5, 69, 225, 124, 222, 218, 168, 51,
                183, 214, 184, 167, 2, 3, 139, 39, 78, 174, 163, 244, 228, 190, 157, 145, 78, 235,
                97, 241, 112, 46, 105, 108, 32, 58, 18, 104, 84,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc2() {
        let key = [74, 101, 102, 101];
        let message = [
            119, 104, 97, 116, 32, 100, 111, 32, 121, 97, 32, 119, 97, 110, 116, 32, 102, 111, 114,
            32, 110, 111, 116, 104, 105, 110, 103, 63,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                22, 75, 122, 123, 252, 248, 25, 226, 227, 149, 251, 231, 59, 86, 224, 163, 135,
                189, 100, 34, 46, 131, 31, 214, 16, 39, 12, 215, 234, 37, 5, 84, 151, 88, 191, 117,
                192, 90, 153, 74, 109, 3, 79, 101, 248, 240, 230, 253, 202, 234, 177, 163, 77, 74,
                107, 75, 99, 110, 7, 10, 56, 188, 231, 55,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc3() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170,
        ];
        let message = [
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
            221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221, 221,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                250, 115, 176, 8, 157, 86, 162, 132, 239, 176, 240, 117, 108, 137, 11, 233, 177,
                181, 219, 221, 142, 232, 26, 54, 85, 248, 62, 51, 178, 39, 157, 57, 191, 62, 132,
                130, 121, 167, 34, 200, 6, 180, 133, 164, 126, 103, 200, 7, 185, 70, 163, 55, 190,
                232, 148, 38, 116, 39, 136, 89, 225, 50, 146, 251,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc4() {
        let key = [
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24,
            25,
        ];
        let message = [
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
            205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205, 205,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                176, 186, 70, 86, 55, 69, 140, 105, 144, 229, 168, 197, 246, 29, 74, 247, 229, 118,
                217, 127, 249, 75, 135, 45, 231, 111, 128, 80, 54, 30, 227, 219, 169, 28, 165, 193,
                26, 162, 94, 180, 214, 121, 39, 92, 197, 120, 128, 99, 165, 241, 151, 65, 18, 12,
                79, 45, 226, 173, 235, 235, 16, 162, 152, 221,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc5() {
        let key = [
            12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12,
        ];
        let message = [
            84, 101, 115, 116, 32, 87, 105, 116, 104, 32, 84, 114, 117, 110, 99, 97, 116, 105, 111,
            110,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code[..16],
            [65, 95, 173, 98, 113, 88, 10, 83, 29, 65, 121, 188, 137, 29, 135, 166,]
        );
    }

    #[test]
    fn test_hmac_sha512_tc6() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
        ];
        let message = [
            84, 101, 115, 116, 32, 85, 115, 105, 110, 103, 32, 76, 97, 114, 103, 101, 114, 32, 84,
            104, 97, 110, 32, 66, 108, 111, 99, 107, 45, 83, 105, 122, 101, 32, 75, 101, 121, 32,
            45, 32, 72, 97, 115, 104, 32, 75, 101, 121, 32, 70, 105, 114, 115, 116,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                128, 178, 66, 99, 199, 193, 163, 235, 183, 20, 147, 193, 221, 123, 232, 180, 155,
                70, 209, 244, 27, 74, 238, 193, 18, 27, 1, 55, 131, 248, 243, 82, 107, 86, 208, 55,
                224, 95, 37, 152, 189, 15, 210, 33, 93, 106, 30, 82, 149, 230, 79, 115, 246, 63,
                10, 236, 139, 145, 90, 152, 93, 120, 101, 152,
            ]
        );
    }

    #[test]
    fn test_hmac_sha512_tc7() {
        let key = [
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
        ];
        let message = [
            84, 104, 105, 115, 32, 105, 115, 32, 97, 32, 116, 101, 115, 116, 32, 117, 115, 105,
            110, 103, 32, 97, 32, 108, 97, 114, 103, 101, 114, 32, 116, 104, 97, 110, 32, 98, 108,
            111, 99, 107, 45, 115, 105, 122, 101, 32, 107, 101, 121, 32, 97, 110, 100, 32, 97, 32,
            108, 97, 114, 103, 101, 114, 32, 116, 104, 97, 110, 32, 98, 108, 111, 99, 107, 45, 115,
            105, 122, 101, 32, 100, 97, 116, 97, 46, 32, 84, 104, 101, 32, 107, 101, 121, 32, 110,
            101, 101, 100, 115, 32, 116, 111, 32, 98, 101, 32, 104, 97, 115, 104, 101, 100, 32, 98,
            101, 102, 111, 114, 101, 32, 98, 101, 105, 110, 103, 32, 117, 115, 101, 100, 32, 98,
            121, 32, 116, 104, 101, 32, 72, 77, 65, 67, 32, 97, 108, 103, 111, 114, 105, 116, 104,
            109, 46,
        ];
        let code = hmac_sha512(&key, &message);
        let verified = hmac_sha512_verify(&key, &message, &code);
        assert!(verified);
        assert_eq!(
            code,
            [
                227, 123, 106, 119, 93, 200, 125, 186, 164, 223, 169, 249, 110, 94, 63, 253, 222,
                189, 113, 248, 134, 114, 137, 134, 93, 245, 163, 45, 32, 205, 201, 68, 182, 2, 44,
                172, 60, 73, 130, 177, 13, 94, 235, 85, 195, 228, 222, 21, 19, 70, 118, 251, 109,
                224, 68, 96, 101, 201, 116, 64, 250, 140, 106, 88,
            ]
        );
    }
}
